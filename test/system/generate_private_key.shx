#!/bin/bash
app_id=2625348
app_private_key="$(< /Users/luigi/syntasso/test-ssh/github-app-testing-git-writer-private.key)"

# Build header and payload
header='{"alg": "RS256", "typ": "JWT"}'
iat=$(date +%s)
payload=$(jq -n \
  --arg iat "$iat" \
  --arg app_id "$app_id" \
  '{iat: ($iat | tonumber), exp: (($iat | tonumber) + 300), iss: ($app_id | tonumber)}')

# Sign and create JWT
b64enc() { openssl enc -base64 -A | tr '+/' '-_' | tr -d '='; }
signed_content="$(echo -n "$header" | b64enc).$(echo -n "$payload" | b64enc)"
signature=$(echo -n "$signed_content" | openssl dgst -binary -sha256 -sign <(echo "$app_private_key") | b64enc)
jwt="$signed_content.$signature"

echo -n $jwt
